<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BankPrep Syllabus Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #4f46e5; --primary-light: #818cf8; --secondary: #ec4899;
            --bg-body: #f8fafc; --bg-card: #ffffff;
            --text-main: #0f172a; --text-muted: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border-color: rgba(0,0,0,0.05);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --radius: 16px; --drawer-bg: #f8fafc; --task-tag-bg: #f1f5f9;
            --modal-overlay: rgba(15, 23, 42, 0.6);
            --chat-user-bg: #4f46e5; --chat-ai-bg: #f1f5f9; --chat-text-ai: #0f172a;
        }

        [data-theme="dark"] {
            --primary: #6366f1; --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --border-color: rgba(255,255,255,0.05);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --drawer-bg: #0f172a; --task-tag-bg: #334155;
            --modal-overlay: rgba(0, 0, 0, 0.85);
            --chat-user-bg: #6366f1; --chat-ai-bg: #334155; --chat-text-ai: #f1f5f9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, color 0.3s ease; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 90px; }

        /* --- AUTH SCREEN --- */
        /* --- AUTH SCREEN (REDESIGNED) --- */
	#authScreen {
		position: fixed;
		inset: 0;
		background: linear-gradient(135deg, var(--primary), var(--secondary));
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 5000;
	}

	.auth-card {
		background: var(--bg-card);
		width: 100%;
		max-width: 360px;
		padding: 32px 28px;
		border-radius: 28px;
		box-shadow: 0 25px 60px rgba(0,0,0,0.25);
		text-align: center;
		animation: fadeIn 0.4s ease;
	}

	.auth-logo {
		font-size: 3.2rem;
		margin-bottom: 8px;
	}

	.auth-title {
		font-size: 1.6rem;
		font-weight: 800;
		margin-bottom: 4px;
	}

	.auth-sub {
		font-size: 0.85rem;
		color: var(--text-muted);
		margin-bottom: 24px;
	}

	.auth-input {
		width: 100%;
		padding: 14px 16px;
		border-radius: 14px;
		border: 1px solid var(--border-color);
		background: var(--bg-body);
		font-size: 0.95rem;
		margin-bottom: 14px;
	}

	.auth-input:focus {
		outline: none;
		border-color: var(--primary);
	}

	.auth-btn {
		width: 100%;
		padding: 14px;
		border-radius: 14px;
		border: none;
		background: linear-gradient(135deg, var(--primary), var(--secondary));
		color: white;
		font-weight: 700;
		font-size: 1rem;
		cursor: pointer;
		margin-top: 5px;
	}

	.auth-link {
		margin-top: 18px;
		font-size: 0.85rem;
		color: var(--primary);
		cursor: pointer;
		font-weight: 600;
	}

        #appContainer { display: none; }

        /* --- HEADER LAYOUT --- */
        .fixed-top-container { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color: var(--bg-body); }
        .app-header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            padding: 20px 20px 50px 20px; 
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; 
            color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); 
            position: relative; z-index: 2; 
        }
        
        /* Updated Flex Layout: Title Stacked, Icons Below Right */
        .header-top { 
            display: flex; flex-direction: column; 
            align-items: flex-start; justify-content: center; 
        }
        .header-actions { 
            align-self: flex-end; margin-top: 10px; 
            display: flex; gap: 12px; 
        }

        .icon-btn { 
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
            color: white; width: 36px; height: 36px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; backdrop-filter: blur(4px); 
        }
        .icon-btn.ai-btn { background: linear-gradient(135deg, #FFD700, #FFA500); border: none; color: #78350f; }

        /* --- GLOBAL UI --- */
        .global-progress-container { margin-top: 20px; background: rgba(0,0,0,0.25); height: 8px; border-radius: 10px; overflow: hidden; position: relative; }
        .global-progress-fill { height: 100%; background: #fff; width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-label { font-size: 0.8rem; text-align: right; margin-top: 6px; font-weight: 600; color: white; }

        .category-nav { display: flex; gap: 12px; overflow-x: auto; padding: 0 20px 15px 20px; margin-top: -35px; scrollbar-width: none; position: relative; z-index: 3; }
        .category-nav::-webkit-scrollbar { display: none; }
        .nav-item { background: var(--bg-card); min-width: 95px; padding: 12px 8px; border-radius: 14px; text-align: center; box-shadow: var(--shadow-card); cursor: pointer; transition: all 0.25s; opacity: 0.95; transform: scale(0.98); border: 2px solid transparent; flex-shrink: 0; }
        .nav-item.active { border-color: var(--primary); transform: scale(1); opacity: 1; }
        .nav-icon { font-size: 1.6rem; display: block; margin-bottom: 2px; }
        .nav-label { font-size: 0.75rem; font-weight: 700; color: var(--text-main); }
		
		.content-area { 
			/* Changed top padding from 10px to 0px */
			padding: 0 20px 25px 20px; 
			animation: fadeIn 0.4s ease-out; 
		}

		/* Find .section-header and update the margin */
		.section-header { 
			font-size: 0.8rem; 
			text-transform: uppercase; 
			letter-spacing: 1.2px; 
			color: var(--text-muted); 
			font-weight: 800; 
			
			/* Changed top margin from 30px to 15px */
			margin: 15px 0 12px 5px; 
			
			display: flex; 
			align-items: center; 
		}
        .section-header::before { content: ''; width: 6px; height: 6px; background: var(--secondary); border-radius: 50%; margin-right: 10px; }

        /* --- TOPIC CARDS --- */
        .topic-wrapper { background: var(--bg-card); border-radius: var(--radius); margin-bottom: 14px; box-shadow: var(--shadow-card); overflow: hidden; border: 1px solid var(--border-color); }
        .topic-main { padding: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: var(--bg-card); position: relative; z-index: 2; }
        .topic-left { display: flex; align-items: center; gap: 14px; flex: 1; }
        .topic-info h3 { margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--text-main); }
        .topic-status { font-size: 0.7rem; margin-top: 4px; color: var(--text-muted); }
        .topic-status.active { color: var(--success); font-weight: 600; }
        .revision-drawer { background: var(--drawer-bg); max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .topic-wrapper.open .revision-drawer { max-height: 400px; border-top: 1px dashed var(--text-muted); }
        .topic-wrapper.open .chevron { transform: rotate(180deg); color: var(--primary); }
        .drawer-content { padding: 16px 18px; }
        .rev-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .rev-meta { display: flex; flex-direction: column; }
        .rev-label { font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        .rev-date { font-size: 0.75rem; color: var(--text-muted); }
        .rev-date.due { color: var(--danger); font-weight: 700; }

        .switch { position: relative; display: inline-block; width: 48px; height: 28px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        [data-theme="dark"] .slider { background-color: #334155; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .master-switch input:checked + .slider { background-color: var(--success); } .master-switch input:checked + .slider:before { transform: translateX(20px); }
        .rev-switch input:checked + .slider { background-color: var(--primary); } .rev-switch input:checked + .slider:before { transform: translateX(20px); }
        .rev-row.locked { opacity: 0.4; pointer-events: none; }

        .task-card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow-card); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--warning); }
        .task-card.r4 { border-left-color: var(--primary); } .task-card.r7 { border-left-color: var(--secondary); } .task-card.completed { opacity: 0.5; filter: grayscale(1); }
        .task-meta h4 { margin: 0 0 5px 0; font-size: 1rem; color: var(--text-main); }
        .task-tag { font-size: 0.75rem; background: var(--task-tag-bg); padding: 3px 8px; border-radius: 6px; color: var(--text-muted); font-weight: 600; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }

        /* --- CHAT OVERLAY --- */
        .chat-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-overlay); z-index: 2500; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .chat-overlay.show { opacity: 1; pointer-events: auto; }
        .chat-container { width: 100%; max-width: 600px; height: 85vh; background: var(--bg-card); border-top-left-radius: 24px; border-top-right-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .chat-overlay.show .chat-container { transform: translateY(0); }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); }
        .chat-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .chat-close { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; background: none; border: none; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: var(--bg-body); }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .message.user { align-self: flex-end; background: var(--chat-user-bg); color: white; border-bottom-right-radius: 4px; }
        .message.ai { align-self: flex-start; background: var(--chat-ai-bg); color: var(--chat-text-ai); border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        .message.system { align-self: center; font-size: 0.8rem; color: var(--text-muted); text-align: center; width: 100%; }
        .message.ai strong { font-weight: 700; color: var(--primary); }
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border-color); background: var(--bg-card); display: flex; gap: 10px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px 15px; border-radius: 24px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-family: inherit; font-size: 0.95rem; resize: none; max-height: 100px; outline: none; }
        .chat-send { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }

        /* --- TOAST --- */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 4000; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { background: #991b1b; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
		/* --- SEARCH BAR --- */
		.search-container {
			padding: 15px 20px 10px 20px;
			background: var(--bg-body);
			transition: background 0.3s ease;
		}

		.search-box {
			position: relative;
			display: flex;
			align-items: center;
		}

		.search-input {
			width: 100%;
			padding: 12px 40px 12px 42px; /* Space for icon and clear btn */
			border-radius: 12px;
			border: 1px solid var(--border-color);
			background: var(--bg-card);
			color: var(--text-main);
			font-family: 'Poppins', sans-serif;
			font-size: 0.9rem;
			outline: none;
			box-shadow: var(--shadow-card);
			transition: all 0.3s ease;
		}

		.search-input:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
		}

		.search-icon {
			position: absolute;
			left: 14px;
			color: var(--text-muted);
			display: flex;
			align-items: center;
			pointer-events: none;
		}

		.search-clear {
			position: absolute;
			right: 12px;
			background: none;
			border: none;
			color: var(--text-muted);
			font-size: 1.2rem;
			cursor: pointer;
			display: none; /* Hidden by default */
			padding: 0;
		}

		.search-clear.show {
			display: block;
		}

		/* Hide sections when searching if no topics match */
		.section-header.hidden {
			display: none;
		}
	</style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-card">
            <span class="auth-logo">üè¶</span>
            <div class="auth-title">BankPrep Cloud</div>
            <div class="auth-sub">Sign in to sync your progress</div>
            <input type="email" id="email" class="auth-input" placeholder="Email Address">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button class="auth-btn" id="mainAuthBtn" onclick="handleLogin()">Sign In</button>
            <div class="auth-link" id="toggleAuthMode" onclick="toggleAuth()">New here? Create Account</div>
            <div id="authError" style="color:var(--danger); font-size:0.8rem; margin-top:10px;"></div>
        </div>
    </div>

    <div id="appContainer">
        <div class="chat-overlay" id="aiChat">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">‚ú® BankPrep Tutor</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="resetApiKey()" style="background:none; border:none; color:var(--text-muted); font-size:0.7rem; cursor:pointer; text-decoration:underline;">Key</button>
                        <button class="chat-close" onclick="closeChat()">√ó</button>
                    </div>
                </div>
                <div class="chat-messages" id="chatHistory"></div>
                <div class="chat-input-area">
                    <textarea class="chat-input" id="chatInput" placeholder="Ask a doubt..." rows="1"></textarea>
                    <button class="chat-send" onclick="sendToGemini()">‚û§</button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast"><span id="toastIcon">‚úÖ</span><span id="toastMsg">Success</span></div>

        <div class="fixed-top-container" id="fixedHeader">
            <header class="app-header">
                <div class="header-top">
                    <div class="header-title">
                        <h1 style="margin: 0; font-size: 1.25rem; font-weight: 700; line-height: 1.3;">
                            BankPrep "Syllabus Tracker"
                        </h1>
                        <div style="font-size: 0.75rem; font-weight: 500; opacity: 0.9; margin-top: 2px;">
                            (By Durga Prasad)
                        </div>
                        <div class="header-subtitle" style="margin-top: 4px;">
                            100% Syllabus Coverage
                        </div>
                    </div>
                    
                    <div class="header-actions">
                        <button class="icon-btn ai-btn" onclick="openChat()" aria-label="AI Tutor">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"/><path d="M20 2v4"/><path d="M22 4h-4"/><circle cx="4" cy="20" r="2"/></svg>
                        </button>
                        <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle Theme"></button>
                        <button class="icon-btn" onclick="handleLogout()" style="font-size: 0.9rem;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg></button>
                    </div>
                </div>
                <div class="global-progress-container"><div class="global-progress-fill" id="globalBar"></div></div>
                <div class="progress-label" id="globalText">0% Complete</div>
            </header>
            <nav class="category-nav" id="categoryNav"></nav>
			<div class="search-container">
				<div class="search-box">
					<span class="search-icon">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
					</span>
					<input type="text" id="topicSearch" class="search-input" placeholder="Search topics in this section..." autocomplete="off">
					<button class="search-clear" id="searchClear" onclick="clearSearch()">√ó</button>
				</div>
			</div>
        </div>

        <main class="content-area" id="contentArea"></main>
    </div>

    <script>
        // ----------------------------------------------------
        // üö® REPLACE WITH YOUR FIREBASE KEYS BELOW
        // ----------------------------------------------------
        const firebaseConfig = {
		  apiKey: "AIzaSyBPSXcRdCoik4vAKJxjB2258bWSpe_6nGU",
		  authDomain: "bankprep-tracker.firebaseapp.com",
		  projectId: "bankprep-tracker",
		  storageBucket: "bankprep-tracker.firebasestorage.app",
		  messagingSenderId: "254084569056",
		  appId: "1:254084569056:web:a6e3a75e0d80372b373d85"
		};
        // ----------------------------------------------------

        // Init Firebase
        if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            firebase.initializeApp(firebaseConfig);
        } else {
            console.error("Firebase not configured. Please add keys in code.");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        const syllabusData = {
            "quant": { label: "Quant", icon: "üìä", sections: [{ title: "Number System", topics: ["Natural, Whole, Integers", "Prime & Composite", "Factors & Multiples", "LCM & HCF", "Divisibility Rules", "Unit Digit", "Cyclicity"] }, { title: "Arithmetic Core", topics: ["Simplification", "Approximation", "BODMAS", "Fractions & Decimals", "Percentages", "Ratio & Proportion", "Average"] }, { title: "Commercial Maths", topics: ["Profit & Loss", "Simple Interest", "Compound Interest", "Time & Work", "Pipes & Cisterns", "Time Speed Distance", "Boats & Streams", "Mixtures & Alligation", "Partnership", "Ages"] }, { title: "Advanced & Mains", topics: ["Permutation & Combination", "Probability (Mains)", "Mensuration 2D", "Mensuration 3D", "Number Series", "Quadratic Equations"] }, { title: "Data Interpretation", topics: ["Table DI", "Bar Graph", "Line Graph", "Pie Chart", "Caselet DI", "Missing DI", "Radar / Web DI"] }] },
            "reasoning": { label: "Logic", icon: "üß†", sections: [{ title: "Speed Reasoning", topics: ["Alphabet Series", "Number Series", "Alphanumeric Series", "Analogy", "Classification", "Inequality", "Syllogism (New Pattern)"] }, { title: "Spatial & Logic", topics: ["Direction & Distance", "Coding-Decoding", "Order & Ranking", "Blood Relations"] }, { title: "Seating Arrangement", topics: ["Linear Row", "Circular Seating", "Square/Rectangular", "Triangular Seating", "Uncertain Number"] }, { title: "Puzzles", topics: ["Floor Based", "Box Based", "Month/Day/Year", "Scheduling", "Designation Based", "Flat & Floor"] }, { title: "Mains Logic", topics: ["Input-Output", "Data Sufficiency", "Statement & Assumption", "Statement & Conclusion", "Cause & Effect", "Course of Action"] }] },
            "english": { label: "English", icon: "üìñ", sections: [{ title: "Grammar Rules", topics: ["Parts of Speech", "Subject-Verb Agreement", "Tenses", "Articles", "Prepositions", "Conjunctions", "Active & Passive Voice", "Direct & Indirect Speech"] }, { title: "Vocabulary", topics: ["Synonyms & Antonyms", "Idioms & Phrases", "Phrasal Verbs", "Root Words", "One-word Substitution", "Word Usage/Swap"] }, { title: "Reading Skills", topics: ["Reading Comprehension", "RC Inference & Tone", "Cloze Test", "Para Jumbles", "Para Completion", "Sentence Rearrangement"] }, { title: "Mains Descriptive", topics: ["Essay Writing", "Letter Writing"] }] },
            "ga": { label: "G.A.", icon: "üè¶", sections: [{ title: "Banking Awareness", topics: ["RBI Functions & Structure", "Monetary Policy", "Repo, Reverse Repo, CRR, SLR", "Types of Accounts", "Basel Norms", "Financial Inclusion", "NPCI (UPI, IMPS)"] }, { title: "Static GK", topics: ["National Parks & Sanctuaries", "Dams & Rivers", "Country Capitals & Currencies", "HQ of Int. Organizations", "Airports & Stadiums", "Power Plants"] }, { title: "Current Affairs", topics: ["Last 6 Months News", "Union Budget", "Government Schemes", "Appointments", "Awards & Honours", "Books & Authors", "Sports News"] }] },
            "computer": { label: "Computer", icon: "üíª", sections: [{ title: "Hardware & OS", topics: ["Generations of Computers", "Input/Output Devices", "Memory (RAM, ROM)", "Operating Systems"] }, { title: "Networking & Security", topics: ["Internet & Browsers", "OSI Model", "IP Addresses & Protocols", "Cyber Security", "Virus & Malware", "MS Office Shortcuts"] }] },
            "schedule": { label: "Today", icon: "üìÖ", sections: [] }
        };

        const API_KEY_STORAGE = 'gemini_api_key';
        const THEME_KEY = 'bank_theme_pref';
        let state = {}; 
        let currentTab = 'quant';
        let isSignup = false;
        let currentUser = null;

        const SUN_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
        const MOON_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>`;

        // AUTH & INIT
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadUserData();
                initTheme();
            } else {
                currentUser = null;
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('mainAuthBtn').textContent = isSignup ? "Create Account" : "Sign In";
            document.getElementById('toggleAuthMode').textContent = isSignup ? "Already have an account? Sign In" : "New here? Create Account";
            document.getElementById('authError').textContent = "";
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errDiv = document.getElementById('authError');
            try {
                if(isSignup) await auth.createUserWithEmailAndPassword(email, pass);
                else await auth.signInWithEmailAndPassword(email, pass);
            } catch(error) { errDiv.textContent = error.message; }
        }
        function handleLogout() { auth.signOut(); }

        // FIRESTORE SYNC
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (doc.exists) state = doc.data().progress || {};
                else state = {};
                renderTabs(); renderContent(currentTab); updateGlobalStats(); adjustPadding();
            });
        }
        function saveState() {
            if(currentUser) db.collection('users').doc(currentUser.uid).set({ progress: state }, { merge: true });
            updateGlobalStats();
        }

        // UTILS
        function getFormattedDate(d) { if(!d) return "-"; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function addDays(d, days) { const date = new Date(d); date.setDate(date.getDate() + days); return date; }
        function isSameDate(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
        function adjustPadding() { document.body.style.paddingTop = (document.getElementById('fixedHeader').offsetHeight + 5) + 'px'; }
        window.addEventListener('resize', adjustPadding);
        function showToast(msg, type='success') { const t=document.getElementById('toast'); document.getElementById('toastIcon').innerText=type==='success'?'‚úÖ':'‚ùå'; document.getElementById('toastMsg').innerText=msg; t.className=`toast ${type} show`; setTimeout(()=>t.classList.remove('show'),3000); }

        // THEME
        function initTheme() { const p = localStorage.getItem(THEME_KEY); if(p==='dark'){document.documentElement.setAttribute('data-theme','dark');document.getElementById('themeBtn').innerHTML=SUN_ICON;}else{document.documentElement.setAttribute('data-theme','light');document.getElementById('themeBtn').innerHTML=MOON_ICON;} }
        window.toggleTheme = function() { const c = document.documentElement.getAttribute('data-theme'); if(c==='light'){document.documentElement.setAttribute('data-theme','dark');localStorage.setItem(THEME_KEY,'dark');document.getElementById('themeBtn').innerHTML=SUN_ICON;}else{document.documentElement.setAttribute('data-theme','light');localStorage.setItem(THEME_KEY,'light');document.getElementById('themeBtn').innerHTML=MOON_ICON;} }

        // AI CHAT (Gemini 2.5)
        function openChat() { 
            document.getElementById('aiChat').classList.add('show'); 
            const history = document.getElementById('chatHistory');
            const key = localStorage.getItem(API_KEY_STORAGE);
            if(!key && history.children.length===0) {
                history.innerHTML = `<div class="message system" id="apiKeyContainer"><div style="background:var(--bg-card); padding:15px; border-radius:12px; border:1px solid var(--border-color); text-align:center;"><p style="margin-bottom:10px;">Welcome to BankPrep AI!</p><input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); margin-bottom:10px;"><button onclick="saveApiKey()" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; width:100%;">Start Learning</button><div style="font-size:0.7rem; margin-top:10px; color:var(--text-muted);">Key is saved locally on your device.</div></div></div>`;
            } else if(history.children.length===0) {
                appendMessage('ai', 'Hello! I am your Banking Exam Tutor. Ask me about concepts, formulas, or strategies!');
            }
        }
        function closeChat() { document.getElementById('aiChat').classList.remove('show'); }
        window.saveApiKey = function() { const v = document.getElementById('apiKeyInput').value.trim(); if(v.length>10){localStorage.setItem(API_KEY_STORAGE, v); document.getElementById('apiKeyContainer').remove(); appendMessage('ai', 'Key saved! How can I help you today?');}else{alert("Invalid Key");} }
        window.resetApiKey = function() { if(confirm("Remove API Key?")){localStorage.removeItem(API_KEY_STORAGE); document.getElementById('chatHistory').innerHTML=''; openChat();} }
        function appendMessage(sender, text) { const h = document.getElementById('chatHistory'); const d = document.createElement('div'); d.className = `message ${sender}`; if(sender==='ai'){d.innerHTML=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>').replace(/\* (.*?)(<br>|$)/g,'<ul><li>$1</li></ul>');}else{d.textContent=text;} h.appendChild(d); h.scrollTop=h.scrollHeight; }
        
        window.sendToGemini = async function() {
            const input = document.getElementById('chatInput'); const text = input.value.trim(); const apiKey = localStorage.getItem(API_KEY_STORAGE);
            if(!text) return;
            if(!apiKey) { appendMessage('system', 'API Key missing.'); return; }
            appendMessage('user', text); input.value = '';
            const loadingId = 'load'+Date.now();
            const h = document.getElementById('chatHistory');
            const ld = document.createElement('div'); ld.className='message ai'; ld.id=loadingId; ld.innerHTML='<i>Thinking...</i>'; h.appendChild(ld); h.scrollTop=h.scrollHeight;
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `You are an expert Bank Exam Tutor (IBPS/SBI). User: ${text}` }] }] })
                });
                const data = await resp.json();
                document.getElementById(loadingId).remove();
                if(data.error) appendMessage('system', 'Error: '+data.error.message);
                else appendMessage('ai', data.candidates[0].content.parts[0].text);
            } catch(e) { document.getElementById(loadingId).remove(); appendMessage('system', 'Connection Error'); }
        }

        // RENDER LOGIC
        function renderTabs() { const n = document.getElementById('categoryNav'); n.innerHTML=''; Object.keys(syllabusData).forEach(k=>{ const d=document.createElement('div'); d.className=`nav-item ${k===currentTab?'active':''}`; d.setAttribute('data-key',k); d.innerHTML=`<span class="nav-icon">${syllabusData[k].icon}</span><span class="nav-label">${syllabusData[k].label}</span>`; d.onclick=()=>{currentTab=k;renderTabs();renderContent(k);window.scrollTo({top:0,behavior:'instant'});}; n.appendChild(d); }); }
        
        function renderContent(k) { 
            const c=document.getElementById('contentArea'); c.innerHTML=''; 
            if(k==='schedule'){renderDailySchedule(c);return;} 
            const sub=syllabusData[k]; 
            sub.sections.forEach(s=>{ 
                const h=document.createElement('div'); h.className='section-header'; h.textContent=s.title; c.appendChild(h); 
                s.topics.forEach(t=>{ 
                    const id=`${k}-${t.replace(/[^a-zA-Z0-9]/g,'')}`; 
                    const td=state[id]||{done:false,date:null}; 
                    let st="Not Started",d1="Locked",d4="Locked",d7="Locked",l=true; 
                    if(td.done&&td.date){st=`Started: ${getFormattedDate(td.date)}`; d1=getFormattedDate(addDays(td.date,1)); d4=getFormattedDate(addDays(td.date,4)); d7=getFormattedDate(addDays(td.date,7)); l=false;} 
                    const cd=document.createElement('div'); 
                    cd.className=`topic-wrapper`; // CLOSED by default
                    cd.id=`card-${id}`; 
                    cd.innerHTML=`<div class="topic-main" onclick="toggleDrawer('${id}')"><div class="topic-left"><span class="chevron">‚ñº</span><div class="topic-info"><h3>${t}</h3><div class="topic-status ${td.done?'active':''}">${st}</div></div></div><label class="switch master-switch" onclick="event.stopPropagation()"><input type="checkbox" onchange="handleMasterToggle('${id}')" ${td.done?'checked':''}><span class="slider"></span></label></div><div class="revision-drawer"><div class="drawer-content"><div class="schedule-title">1-4-7 Revision Schedule</div>${renderRevRow(id,'r1','1st Revision (Day 1)',d1,td.r1,l)}${renderRevRow(id,'r4','4th Day Revision',d4,td.r4,l)}${renderRevRow(id,'r7','7th Day Revision',d7,td.r7,l)}</div></div>`; 
                    c.appendChild(cd); 
                }); 
            }); 
        }
		// --- SEARCH FUNCTIONALITY ---

		const searchInput = document.getElementById('topicSearch');
		const clearBtn = document.getElementById('searchClear');

		// 1. Listen for typing
		searchInput.addEventListener('input', function(e) {
			const term = e.target.value.toLowerCase().trim();
			filterTopics(term);
			
			// Toggle clear button visibility
			if (term.length > 0) clearBtn.classList.add('show');
			else clearBtn.classList.remove('show');
		});

		// 2. Clear function
		function clearSearch() {
			searchInput.value = '';
			filterTopics('');
			clearBtn.classList.remove('show');
			searchInput.focus();
		}

		// 3. The Core Filter Logic
		function filterTopics(term) {
			const contentArea = document.getElementById('contentArea');
			
			// Get all topic cards and section headers
			const cards = contentArea.querySelectorAll('.topic-wrapper');
			const headers = contentArea.querySelectorAll('.section-header');

			// Step A: Filter individual cards
			cards.forEach(card => {
				const title = card.querySelector('h3').textContent.toLowerCase();
				// Check if title contains search term
				if (title.includes(term)) {
					card.style.display = 'block';
					card.classList.remove('hidden-by-search');
				} else {
					card.style.display = 'none';
					card.classList.add('hidden-by-search');
				}
			});

			// Step B: Hide Section Headers if all their topics are hidden
			// We iterate through contentArea children to find groups
			let currentHeader = null;
			let visibleCount = 0;

			Array.from(contentArea.children).forEach(child => {
				if (child.classList.contains('section-header')) {
					// If we finished a previous section, check if it had visible items
					if (currentHeader) {
						currentHeader.style.display = visibleCount > 0 ? 'flex' : 'none';
					}
					// Start new section
					currentHeader = child;
					visibleCount = 0;
				} else if (child.classList.contains('topic-wrapper')) {
					if (child.style.display !== 'none') {
						visibleCount++;
					}
				}
			});
			
			// Check the last section
			if (currentHeader) {
				currentHeader.style.display = visibleCount > 0 ? 'flex' : 'none';
			}
		}

		// 4. Important: Clear search when switching tabs
		// Find your existing renderContent function and add this line at the top:
		const originalRender = renderContent; // Store reference if needed
		renderContent = function(k) {
			// Clear search UI
			if(searchInput) {
				searchInput.value = '';
				clearBtn.classList.remove('show');
			}
			
			// Run original logic (paste your original function body here or call it)
			// ... (Your existing renderContent logic goes here) ...
			// Since we are overriding, just ensure the logic below runs:
			
			const c = document.getElementById('contentArea'); 
			c.innerHTML=''; 
			
			if(k==='schedule'){ renderDailySchedule(c); return; } 
			
			const sub = syllabusData[k]; 
			sub.sections.forEach(s => { 
				const h = document.createElement('div'); 
				h.className = 'section-header'; 
				h.textContent = s.title; 
				c.appendChild(h); 
				s.topics.forEach(t => { 
					// ... (Your existing card creation logic) ...
					// Copy the exact logic from your previous renderContent here
					const id=`${k}-${t.replace(/[^a-zA-Z0-9]/g,'')}`;
					const td=state[id]||{done:false,date:null};
					let st="Not Started",d1="Locked",d4="Locked",d7="Locked",l=true;
					if(td.done&&td.date){st=`Started: ${getFormattedDate(td.date)}`; d1=getFormattedDate(addDays(td.date,1)); d4=getFormattedDate(addDays(td.date,4)); d7=getFormattedDate(addDays(td.date,7)); l=false;}
					const cd=document.createElement('div');
					cd.className=`topic-wrapper`;
					cd.id=`card-${id}`;
					cd.innerHTML=`<div class="topic-main" onclick="toggleDrawer('${id}')"><div class="topic-left"><span class="chevron">‚ñº</span><div class="topic-info"><h3>${t}</h3><div class="topic-status ${td.done?'active':''}">${st}</div></div></div><label class="switch master-switch" onclick="event.stopPropagation()"><input type="checkbox" onchange="handleMasterToggle('${id}')" ${td.done?'checked':''}><span class="slider"></span></label></div><div class="revision-drawer"><div class="drawer-content"><div class="schedule-title">1-4-7 Revision Schedule</div>${renderRevRow(id,'r1','1st Revision (Day 1)',d1,td.r1,l)}${renderRevRow(id,'r4','4th Day Revision',d4,td.r4,l)}${renderRevRow(id,'r7','7th Day Revision',d7,td.r7,l)}</div></div>`;
					c.appendChild(cd);
				}); 
			});
			
			// Adjust padding after render
			adjustPadding();
		};

        function renderRevRow(id,k,l,d,c,loc){ return `<div class="rev-row ${loc?'locked':''}"><div class="rev-meta"><span class="rev-label">${l}</span><span class="rev-date ${!loc&&!c?'due':''}">${loc?'Topic Locked':(c?'Done':'Due: '+d)}</span></div><label class="switch rev-switch"><input type="checkbox" onchange="handleRevToggle('${id}','${k}')" ${c?'checked':''} ${loc?'disabled':''}><span class="slider"></span></label></div>`; }

        function renderDailySchedule(c) { const t=new Date(); let f=false; const h=document.createElement('div'); h.className='section-header'; h.innerHTML=`Tasks due: ${getFormattedDate(t)}`; c.appendChild(h); Object.keys(syllabusData).filter(k=>k!=='schedule').forEach(sk=>{ syllabusData[sk].sections.forEach(s=>{ s.topics.forEach(tp=>{ const id=`${sk}-${tp.replace(/[^a-zA-Z0-9]/g,'')}`; const d=state[id]; if(d&&d.done&&d.date){ const sd=new Date(d.date); if(isSameDate(addDays(sd,1),t)){renderTaskCard(c,id,tp,'1st Revision','r1',d.r1);f=true;} if(isSameDate(addDays(sd,4),t)){renderTaskCard(c,id,tp,'4th Day Revision','r4',d.r4);f=true;} if(isSameDate(addDays(sd,7),t)){renderTaskCard(c,id,tp,'7th Day Revision','r7',d.r7);f=true;} } }); }); }); if(!f) c.innerHTML+=`<div class="empty-state"><div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div><h3>All caught up!</h3><p>No revisions due today.</p></div>`; }
        function renderTaskCard(c,id,name,l,k,comp){ const cd=document.createElement('div'); cd.className=`task-card ${k} ${comp?'completed':''}`; cd.innerHTML=`<div class="task-meta"><span class="task-tag">${l}</span><h4>${name}</h4></div><label class="switch rev-switch"><input type="checkbox" onchange="handleRevToggle('${id}','${k}')" ${comp?'checked':''}><span class="slider"></span></label>`; c.appendChild(cd); }
        
        // INTERACTION HANDLERS
        window.toggleDrawer=function(id){ document.getElementById(`card-${id}`).classList.toggle('open'); }
        window.handleMasterToggle=function(id){ const c=event.target.checked; if(!state[id])state[id]={}; if(c){state[id].done=true;state[id].date=new Date().toISOString(); setTimeout(()=>document.getElementById(`card-${id}`).classList.add('open'),100);}else{state[id].done=false;state[id].date=null; document.getElementById(`card-${id}`).classList.remove('open');} saveState(); renderContent(currentTab); }
        window.handleRevToggle=function(id,k){ const c=event.target.checked; if(state[id]){state[id][k]=c; saveState(); if(currentTab==='schedule')renderContent('schedule'); else renderContent(currentTab);} }
        function updateGlobalStats(){ let t=0,c=0; Object.keys(syllabusData).filter(k=>k!=='schedule').forEach(sk=>{ syllabusData[sk].sections.forEach(s=>{ s.topics.forEach(tp=>{ t++; const id=`${sk}-${tp.replace(/[^a-zA-Z0-9]/g,'')}`; if(state[id]&&state[id].done)c++; }); }); }); const p=t===0?0:Math.round((c/t)*100); document.getElementById('globalBar').style.width=`${p}%`; document.getElementById('globalText').textContent=`${p}% Syllabus Covered`; }
    </script>
</body>
</html>
